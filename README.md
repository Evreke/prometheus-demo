# Как пользоваться репозиторием

Вся функциональность разбита по веткам.

1. [Добавление Prometheus](https://github.com/Evreke/prometheus-hello/tree/feature/prometheus-added)
2. [Добавление Alertmanager](https://github.com/Evreke/prometheus-hello/tree/feature/alertmanager-added)

# Prometheus

Файл prometheus.yml содержит простую конфигурацию для Prometheus.

| Параметр        | Назначение                                                                                                                  |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------|
| scrape_interval | Как часто прометей будет забирать (скрапить) метрики с хостов                                                               |
| scrape_timeout  | Если скрапинг не завершится за время заданное в этом параметре, тогда случится timeout                                      |
| external_labels | Список меток и значений присваемых временным рядам при взаимодействии с Prometheus (remote storage, alertmanager, federation) |
| scrape_configs  | Конфигурация задач на сбор метрик с экспортеров или с помощью федерации                                                     |

В данной конфигурации Prometheus каждые 15 секунд будет собирать собственные метрики и метрики postgres отдаваемые через postgres_exporter

## Генерация синтетических метрик

1. Запусти сервисы командой docker-compose up -d
2. Подключись к веб-интерфейсу прометея по адресу http://localhost:9090/graph
3. Найди метрики с помощью запроса pg_stat_user_tables_n_live_tup{relname="first_table"}. Метрика должна показать, что таблица first_table содержит 100k строк.
4. Запусти скрипт delete.sh, подожди 15 секунд и проверь метрики ещё раз. Шкала должна устремиться вниз и показывать, что в таблице 0 записей.
5. Запусти скрипт create.sh и шкала покажет, что в таблицу добавлено 100k записей.

# Alertmanager

Принимает решение о том куда отправить уведомление о входящем от prometheus предупреждении

* Фильтрует входящие от prometheus предупреждения по заданным в конфигурации правилам
* Принимает решение куда отправить сообщение
* Позволяет обогатить уведомление дополнительной метаинформацией

## Базовая конфигурация - alerting.rules.yml, alertmanager.yml

Как работает:
1. В alerting.rules.yml содержатся тривиальные правила для отслеживания состояния postgres сервиса.
   При недоступности сервиса в течение 10 секунд prometheus отправит предупреждение в alertmanger

Как проверить:
* Запусти все сервисы, а затем погаси сервис postgres
* Проверить админ интерфейс alertmanager

## Расширенная конфигурация - alerting.extended.rules.yml, alertmanager.yml

Как работает:
1. В alerting.extended.rules.yml находятся правила:
   1. для уведомления потребителя о падении базы - PostgreInstanceDown.
   2. для уведомления команды backend при недоступности 50% контейнеров с базами данных.
   3. для уведомления команды backend при недоступности 100% контейнеров с базами данных.
2. Alertmanager настроен так, чтобы сообщения для потребителей и для команды backend отправлялись в соответствующие каналы

Как проверить:
* Создай два url для slack api webhooks для двух разных каналов. Укажи по каналу для получателей в alertmanager.yml конфиге 
* Запусти все сервисы, а затем отключай один или сразу оба контейнера с базами данных
* Через 30-60 секунд в slack придёт первое предупреждение.

# Примечание

Данные примеры не отражают лучшие практики, а служат исключительно для демонстрации возможностей prometheus\alertmanager